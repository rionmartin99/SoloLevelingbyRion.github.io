<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solo Leveling | Hunter Terminal</title>

    <!-- EXTERNAL LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Chart.js for Analytics Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">

    <style>
        /* FALLBACKS */
        .hidden {
            display: none !important;
        }

        /* Base Styles */
        body {
            background-color: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
        }

        .cinzel {
            font-family: 'Cinzel', serif;
        }

        /* Scanline Animation */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #3b82f6;
            box-shadow: 0 0 20px #3b82f6;
            animation: scan 3s linear infinite;
            opacity: 0.5;
            pointer-events: none;
            z-index: 40;
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        /* Rank Colors */
        .rank-s {
            color: #d946ef;
            text-shadow: 0 0 20px #d946ef;
        }

        .rank-a {
            color: #ef4444;
            text-shadow: 0 0 20px #ef4444;
        }

        .rank-b {
            color: #f97316;
            text-shadow: 0 0 20px #f97316;
        }

        .rank-c {
            color: #3b82f6;
            text-shadow: 0 0 20px #3b82f6;
        }

        .rank-d {
            color: #10b981;
            text-shadow: 0 0 15px #10b981;
        }

        .rank-e {
            color: #94a3b8;
            text-shadow: 0 0 10px #94a3b8;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scanner Mirror Fix & UI */
        #reader {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 0.5rem;
            transform: none !important;
        }

        .scanner-ui-corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            z-index: 30;
        }

        .c-tl {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
            border-radius: 8px 0 0 0;
        }

        .c-tr {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
            border-radius: 0 8px 0 0;
        }

        .c-bl {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 8px;
        }

        .c-br {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 8px 0;
        }

        .scanner-laser {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #60a5fa;
            box-shadow: 0 0 20px #60a5fa, 0 0 10px #2563eb;
            animation: laserScan 2s ease-in-out infinite;
            z-index: 25;
        }

        @keyframes laserScan {
            0% {
                top: 5%;
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                top: 95%;
                opacity: 0.5;
            }
        }

        .hex-bg {
            background-color: #000000;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%231e3a8a' fill-opacity='0.2' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Quest Scrollbar */
        .quest-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .quest-scroll::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .quest-scroll::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 2px;
        }

        /* Custom Scroll for VS Team lists */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }

        /* VS Mode Styles */
        .vs-card {
            transition: all 0.3s ease;
        }

        .vs-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .vs-red-glow {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            border-color: rgba(239, 68, 68, 0.6);
        }

        .vs-blue-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.6);
        }

        .vs-modal-bg {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }

        /* Mobile Helper Classes */
        .text-shadow-glow {
            text-shadow: 0 0 10px currentColor;
        }

        /* Safe Area Fix for Mobile Browsers */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* System Message Toast */
        #system-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            border: 1px solid #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            text-align: center;
            min-width: 300px;
            pointer-events: none;
        }

        #system-toast.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        #system-toast.error {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
            color: #fecaca;
        }

        /* Notifications Log Aesthetic */
        .terminal-font {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: -0.5px;
        }

        .log-quest {
            color: #4ade80;
            border-left: 2px solid #4ade80;
            padding-left: 8px;
            background: linear-gradient(90deg, rgba(74, 222, 128, 0.1) 0%, transparent 100%);
        }

        .log-combat {
            color: #f87171;
            border-left: 2px solid #f87171;
            padding-left: 8px;
            background: linear-gradient(90deg, rgba(248, 113, 113, 0.1) 0%, transparent 100%);
        }
    </style>
</head>

<body class="flex items-center justify-center h-screen w-screen relative bg-black overflow-hidden">
    <div class="scan-line"></div>

    <!-- Dark overlay to ensure text readability -->
    <div class="absolute inset-0 bg-black/50 z-0"></div>

    <!-- Standby / Main Menu -->
    <div id="standby"
        class="w-full max-w-4xl px-4 text-center space-y-8 transition-opacity duration-500 z-10 relative flex flex-col items-center justify-center h-full safe-bottom">
        <div id="logo-container" class="mb-4 flex justify-center w-full">
            <h1
                class="text-5xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-blue-100 to-blue-900 cinzel tracking-tighter">
                SOLO<br>LEVELING</h1>
        </div>
        <div class="text-blue-500 animate-pulse text-lg md:text-xl font-mono">SYSTEM ONLINE // AWAITING COMMAND</div>
        <div class="flex flex-col sm:flex-row justify-center gap-4 w-full sm:w-auto">
            <button id="btn-license-scan"
                class="bg-blue-700/80 hover:bg-blue-600/80 text-white px-6 py-3 md:px-8 rounded-sm font-bold backdrop-blur-md border border-blue-500 uppercase tracking-widest hover:shadow-[0_0_20px_rgba(37,99,235,0.6)] transition-all w-full sm:w-auto cursor-pointer relative z-50">
                Hunter License Scan
            </button>
            <button id="btn-hunter-interface"
                class="bg-emerald-700/80 hover:bg-emerald-600/80 text-white px-6 py-3 md:px-8 rounded-sm font-bold backdrop-blur-md border border-emerald-500 uppercase tracking-widest hover:shadow-[0_0_20px_rgba(16,185,129,0.6)] transition-all w-full sm:w-auto cursor-pointer relative z-50">
                Hunter Interface
            </button>
            <button id="btn-vs-mode"
                class="bg-red-700/80 hover:bg-red-600/80 text-white px-6 py-3 md:px-8 rounded-sm font-bold backdrop-blur-md border border-red-500 uppercase tracking-widest hover:shadow-[0_0_20px_rgba(239,68,68,0.6)] transition-all w-full sm:w-auto cursor-pointer relative z-50">
                VS Mode
            </button>
        </div>
        <p class="text-gray-500 text-[10px] md:text-xs font-mono max-w-xs mx-auto md:max-w-none">
            PRESS [HUNTER INTERFACE] TO LOG-IN TO YOUR ACCOUNT</p>

        <!-- New Notification Area -->
        <div class="w-full max-w-2xl mt-auto pt-8 flex flex-col gap-2">
            <!-- System Notification (Combat + Completion) -->
            <div
                class="w-full bg-black/80 border-t-2 border-red-900/50 backdrop-blur-sm p-4 terminal-font text-left relative overflow-hidden h-32 flex flex-col">
                <div
                    class="text-[10px] text-red-500 uppercase tracking-widest mb-2 border-b border-red-900/30 pb-1 flex-shrink-0">
                    System Notification</div>
                <!-- Updated: removed justify-end, added overflow-y-auto for scroll -->
                <div id="system-notifications-log"
                    class="space-y-2 h-full overflow-y-auto flex-grow flex flex-col pr-1 custom-scroll">
                    <div class="text-gray-600 italic text-xs">System Idle...</div>
                </div>
            </div>

            <!-- Quest Notification (New Quests Only) -->
            <div
                class="w-full bg-black/80 border-t-2 border-blue-900/50 backdrop-blur-sm p-4 terminal-font text-left relative overflow-hidden h-32 flex flex-col">
                <div
                    class="text-[10px] text-blue-500 uppercase tracking-widest mb-2 border-b border-blue-900/30 pb-1 flex-shrink-0">
                    Quest Notification</div>
                <!-- Updated: removed justify-end, added overflow-y-auto for scroll -->
                <div id="quest-notifications-log"
                    class="space-y-2 h-full overflow-y-auto flex-grow flex flex-col pr-1 custom-scroll">
                    <div class="text-gray-600 italic text-xs">Scanning for missions...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Overlay -->
    <div id="scanner-overlay" class="hidden absolute inset-0 z-50 hex-bg flex flex-col items-center justify-center p-4">
        <h2 id="scanner-title"
            class="text-lg md:text-2xl font-bold text-blue-400 cinzel mb-8 tracking-[0.2em] md:tracking-[0.5em] animate-pulse text-center">
            SYSTEM PROCESSING</h2>

        <div class="relative w-full max-w-[300px] md:max-w-sm aspect-square p-1">
            <div class="scanner-ui-corner c-tl"></div>
            <div class="scanner-ui-corner c-tr"></div>
            <div class="scanner-ui-corner c-bl"></div>
            <div class="scanner-ui-corner c-br"></div>
            <div class="scanner-laser"></div>
            <div class="w-full h-full bg-black/50 border border-blue-900/50 rounded-lg overflow-hidden relative">
                <div id="reader" class="w-full h-full"></div>
                <div
                    class="absolute inset-0 bg-[linear-gradient(rgba(59,130,246,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(59,130,246,0.1)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none">
                </div>
            </div>
        </div>

        <div class="mt-8 flex gap-4">
            <div class="text-xs text-blue-500 font-mono typing-effect">Looking for Hunter Signature...</div>
        </div>

        <button id="btn-terminate-scan"
            class="mt-8 text-red-500 hover:text-white hover:bg-red-600 font-bold uppercase tracking-widest border border-red-500 px-8 py-2 rounded-sm transition-all text-sm cursor-pointer relative z-50">
            TERMINATE CONNECTION
        </button>
    </div>

    <!-- AP INPUT OVERLAY (Renamed from SP) -->
    <div id="ap-input-overlay"
        class="hidden absolute inset-0 z-[60] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-gray-900 border border-blue-500/50 p-6 rounded-xl w-full max-w-sm text-center shadow-[0_0_30px_rgba(37,99,235,0.3)] animate-fade-in-up">
            <h3 class="text-xl font-bold text-white cinzel mb-2">MANA STAKE (AP)</h3>
            <div id="ap-modal-hunter-name" class="text-blue-400 font-mono text-sm mb-4">HUNTER NAME</div>

            <div class="mb-6 bg-black/50 p-4 rounded border border-gray-700">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">AVAILABLE AP</div>
                <div id="ap-modal-available" class="text-2xl font-mono text-emerald-400">0</div>
            </div>

            <div class="mb-6">
                <label class="text-[10px] text-gray-500 uppercase tracking-widest block mb-1">STAKE AMOUNT</label>
                <input type="number" id="ap-input-field"
                    class="w-full bg-black border border-gray-600 text-white text-center text-3xl font-bold p-3 rounded focus:border-blue-500 outline-none transition-colors"
                    placeholder="0">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="App.VS.cancelApInput()"
                    class="border border-gray-600 text-gray-400 hover:text-white py-3 rounded font-bold uppercase text-sm transition-colors">CANCEL</button>
                <button onclick="App.VS.submitApInput()"
                    class="bg-blue-700 hover:bg-blue-600 text-white py-3 rounded font-bold uppercase text-sm shadow-lg transition-colors">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- QUIT CONFIRMATION OVERLAY (Replaces window.confirm) -->
    <div id="quit-confirm-overlay"
        class="hidden absolute inset-0 z-[70] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-gray-900 border border-red-500/50 p-6 rounded-xl w-full max-w-sm text-center shadow-[0_0_30px_rgba(220,38,38,0.3)] animate-fade-in-up">
            <h3 class="text-2xl font-black text-red-500 cinzel mb-4">WARNING</h3>
            <p class="text-gray-300 font-mono text-sm mb-6">ABORTING COMBAT?<br><span
                    class="text-red-400 text-xs">PENALTY: -1 AP (RANDOM PLAYER/TEAM)</span></p>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="App.VS.cancelQuit()"
                    class="border border-gray-600 text-gray-400 hover:text-white py-3 rounded font-bold uppercase text-sm transition-colors">CANCEL</button>
                <button onclick="App.VS.confirmQuit()"
                    class="bg-red-900/80 hover:bg-red-700 text-white py-3 rounded font-bold uppercase text-sm shadow-lg border border-red-500 transition-colors">ABORT</button>
            </div>
        </div>
    </div>

    <!-- Status View -->
    <div id="status"
        class="hidden w-full h-full md:h-auto md:max-h-[90vh] md:max-w-5xl p-4 md:p-10 z-10 relative overflow-y-auto md:overflow-visible safe-bottom">
        <!-- Injected Content -->
    </div>

    <!-- VS Mode View -->
    <div id="vs-interface"
        class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm overflow-hidden pb-16">
        <!-- VS Content Injected Here -->
    </div>

    <!-- Notification Toast -->
    <div id="system-toast">Notification Message</div>

    <script>
        // *** SYSTEM CORE ***

        document.addEventListener("DOMContentLoaded", () => {

            // === CONFIGURATION ===
            const API_URL = "https://script.google.com/macros/s/AKfycbzQdUyA_FqRW_m7I3HOy3Wuf09T_2tv5DSy-52pRElZlfSpXHnpSIiyoD84fXlQm76_/exec";
            const PROXIES = ["https://corsproxy.io/?", "https://api.allorigins.win/raw?url="];

            const App = {
                // --- STATE ---
                state: {
                    profileTimeout: null, // Timer for auto-close
                    activeTab: 'stats', // Persist tab state
                    systemData: { hunters: {}, settings: {}, quests: [], logs: [] },
                    html5QrCode: null,
                    currentHunterId: null,
                    scanContext: 'profile',
                    profileTimeout: null,
                    toastTimeout: null,
                    vs: {
                        active: false,
                        format: 0,
                        redTeam: [],
                        blueTeam: [],
                        activeSlot: null,
                        phase: 'setup',
                        pool: 0,
                        pendingScan: null
                    }
                },

                // --- DOM ELEMENTS ---
                els: {
                    // Views
                    standby: document.getElementById('standby'),
                    status: document.getElementById('status'),
                    vsInterface: document.getElementById('vs-interface'),
                    scannerOverlay: document.getElementById('scanner-overlay'),

                    // New AP Modal Elements
                    apInputOverlay: document.getElementById('ap-input-overlay'),
                    apInputName: document.getElementById('ap-modal-hunter-name'),
                    apInputAvailable: document.getElementById('ap-modal-available'),
                    apInputField: document.getElementById('ap-input-field'),

                    // Quit Overlay
                    quitOverlay: document.getElementById('quit-confirm-overlay'),

                    // Buttons
                    btnInterface: document.getElementById('btn-system-interface'),
                    btnVsMode: document.getElementById('btn-vs-mode'),
                    btnTerminateScan: document.getElementById('btn-terminate-scan'),

                    // UI Components
                    scannerTitle: document.getElementById('scanner-title'),
                    logoContainer: document.getElementById('logo-container'),
                    systemToast: document.getElementById('system-toast'),
                    questNotificationsLog: document.getElementById('quest-notifications-log'),
                    systemNotificationsLog: document.getElementById('system-notifications-log')
                },

                // --- INITIALIZATION ---
                init() {
                    console.log("System Online.");

                    // 1. Bind Events
                    this.bindEvents();

                    // 2. Global Error Handler
                    window.onerror = (msg, url, line) => {
                        // Ignore benign errors
                        if (typeof msg === 'string') {
                            const lowerMsg = msg.toLowerCase();
                            if (lowerMsg.includes("script error")) return;
                            if (lowerMsg.includes("resizeobserver")) return; // Ignore layout loop errors
                            if (lowerMsg.includes("renderedcamera") || lowerMsg.includes("surfaceonabort")) return; // Ignore harmless camera abort errors
                        }
                        App.UI.showToast("System Error: " + msg, true);
                    };

                    // 3. Start Data Sync
                    // 3. Start Data Sync
                    this.API.refreshData().then(() => {
                        App.Profile.checkPersistence();
                    });
                    setInterval(() => this.API.refreshData(), 15000);

                    // 4. Keyboard Shortcuts
                    this.bindKeys();
                },

                // --- EVENT BINDING ---
                bindEvents() {
                    document.getElementById('btn-license-scan').onclick = () => App.Scanner.start('profile');
                    document.getElementById('btn-hunter-interface').onclick = () => {
                        const savedId = localStorage.getItem('hunter_id');
                        if (savedId) {
                            App.Profile.login(savedId);
                        } else {
                            App.Scanner.start('login');
                        }
                    };
                    document.getElementById('btn-vs-mode').onclick = () => App.VS.enterMode();
                    this.els.btnTerminateScan.addEventListener('click', () => this.Scanner.stop());
                },

                bindKeys() {
                    let buffer = "";
                    document.addEventListener('keydown', (e) => {
                        // Spacebar Demo Mode
                        if (e.code === 'Space') {
                            if (!this.state.systemData.settings || this.state.systemData.settings['demo_active'] !== 'true') return;
                            const allHunters = Object.values(this.state.systemData.hunters).flat();
                            if (allHunters.length > 0) {
                                const r = allHunters[Math.floor(Math.random() * allHunters.length)];
                                if (this.state.vs.active && this.state.vs.phase === 'reg' && this.state.vs.activeSlot) {
                                    const context = this.state.vs.activeSlot.team === 'red' ? 'vs_red' : 'vs_blue';
                                    this.VS.processScan(r.ID, context);
                                } else {
                                    this.Profile.show(r.ID);
                                }
                            }
                        }

                        // Scanner Input Buffer
                        if (e.key === 'Enter') {
                            if (buffer.length > 0) {
                                if (this.state.vs.active && this.state.vs.phase === 'reg' && this.state.vs.activeSlot) {
                                    const context = this.state.vs.activeSlot.team === 'red' ? 'vs_red' : 'vs_blue';
                                    this.VS.processScan(buffer, context);
                                } else {
                                    // Find hunter manually
                                    if (this.state.systemData.hunters) {
                                        for (const [sec, list] of Object.entries(this.state.systemData.hunters)) {
                                            const hunter = list.find(h => h.ID === buffer);
                                            if (hunter) { this.Profile.show(hunter.ID); break; }
                                        }
                                    }
                                }
                                buffer = "";
                            }
                        } else if (e.key.length === 1) {
                            buffer += e.key;
                        }
                    });
                },

                // --- API HANDLER ---
                API: {
                    async refreshData() {
                        const targets = [
                            `${API_URL}?op=getData&_t=${Date.now()}`, // Direct
                            `${PROXIES[0]}${encodeURIComponent(API_URL + '?op=getData')}&_t=${Date.now()}`, // Proxy 1
                            `${PROXIES[1]}${encodeURIComponent(API_URL + '?op=getData')}&_t=${Date.now()}`  // Proxy 2
                        ];

                        for (let i = 0; i < targets.length; i++) {
                            try {
                                const response = await fetch(targets[i]);
                                if (!response.ok) throw new Error("Network response not ok");

                                const contentType = response.headers.get("content-type");
                                if (contentType && contentType.indexOf("application/json") === -1) {
                                    console.warn(`Attempt ${i + 1}: Received HTML instead of JSON.`);
                                    continue; // Try next target
                                }

                                const data = await response.json();
                                // Handle Proxy Wrappers
                                const finalData = (data.contents) ? JSON.parse(data.contents) : data;

                                if (finalData.status === 'error') {
                                    App.UI.showToast("Config Error: " + finalData.message, true);
                                    return;
                                }

                                App.Helpers.normalizeData(finalData); // Normalize immediately
                                App.state.systemData = finalData;
                                App.UI.updateVisuals();
                                App.UI.renderNotifications();
                                console.log(`Kiosk: Synced via ${i === 0 ? 'Direct' : 'Proxy ' + i}`);
                                return; // Success!
                            } catch (e) {
                                console.warn(`Sync attempt ${i + 1} failed:`, e);
                            }
                        }
                        console.error("All sync attempts failed.");
                        // Optional: Show offline toast if needed, but keeping silent to avoid spamming
                    },

                    async postVsResult(op, payload, attempts = 5) {
                        const delay = (ms) => new Promise(res => setTimeout(res, ms));

                        for (let i = 0; i < attempts; i++) {
                            try {
                                if (i > 0) App.UI.showToast(`Network unstable. Retrying... (${i}/${attempts})`, true);

                                await fetch(API_URL, {
                                    method: 'POST',
                                    mode: 'no-cors', // Standard for GAS Web Apps (opaque response)
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ op, ...payload })
                                });
                                return; // Success (Opaque response doesn't allow checking .ok)
                            } catch (e) {
                                console.warn(`Attempt ${i + 1} failed:`, e);
                                if (i === attempts - 1) throw e;
                                await delay(2000 + (i * 1000)); // Wait 2s, 3s, 4s, etc.
                            }
                        }
                    }
                },

                // --- UI MANAGER ---
                UI: {
                    showToast(msg, isError = false) {
                        const toast = App.els.systemToast;
                        toast.textContent = msg;
                        if (isError) toast.classList.add('error'); else toast.classList.remove('error');

                        // Clear existing timeout to handle rapid messages
                        if (App.state.toastTimeout) clearTimeout(App.state.toastTimeout);

                        toast.classList.add('active');
                        App.state.toastTimeout = setTimeout(() => toast.classList.remove('active'), 3000);
                    },

                    updateVisuals() {
                        const s = App.state.systemData.settings;
                        if (!s) return;
                        if (s.bg_terminal) document.body.style.backgroundImage = `url('${App.Helpers.getDirectGdriveUrl(s.bg_terminal)}')`;
                        if (s.logo_main) App.els.logoContainer.innerHTML = `<img src="${App.Helpers.getDirectGdriveUrl(s.logo_main)}" class="h-24 md:h-48 w-auto object-contain drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">`;
                    },

                    renderNotifications() {
                        const logs = App.state.systemData.logs || [];
                        const quests = App.state.systemData.quests || [];

                        // 1. Process Quest Notifications
                        const questLogs = logs.filter(l => l[2] === 'Quest Created').slice().reverse();

                        if (questLogs.length === 0) {
                            App.els.questNotificationsLog.innerHTML = '<div class="text-gray-600 italic text-xs">No recent missions...</div>';
                        } else {
                            const questHtml = questLogs.map(l => {
                                const time = new Date(l[0]).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                let msg = l[3];

                                const matchedQuest = quests.find(q => msg.includes(q.Title));
                                let deadlineHtml = '';

                                if (matchedQuest && matchedQuest.Deadline) {
                                    const d = new Date(matchedQuest.Deadline);
                                    const now = new Date();
                                    const isExpired = now > d;
                                    const deadlineStr = d.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                    const color = isExpired ? 'text-red-400' : 'text-yellow-400';
                                    deadlineHtml = ` <span class="block ${color} text-[10px] font-mono ml-2 border-l border-gray-600 pl-2">Deadline: ${deadlineStr}</span>`;
                                }

                                return `<div class="mb-1 log-quest opacity-80 hover:opacity-100 transition-opacity text-xs md:text-sm shrink-0">
                            <span class="opacity-50 font-mono mr-2">[${time}]</span><span class="font-bold tracking-wider">NEW MISSION:</span> ${msg}
                            ${deadlineHtml}
                        </div>`;
                            }).join('');
                            App.els.questNotificationsLog.innerHTML = questHtml;
                        }

                        // 2. Process System Notifications (Combat + Completion)
                        const systemLogs = logs.filter(l => l[2] === 'Match Finished' || l[2] === 'XP Update').slice().reverse();

                        if (systemLogs.length === 0) {
                            App.els.systemNotificationsLog.innerHTML = '<div class="text-gray-600 italic text-xs">System Idle...</div>';
                        } else {
                            const systemHtml = systemLogs.map(l => {
                                const time = new Date(l[0]).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                const type = l[2];
                                let msg = String(l[3] || ""); // Ensure string to prevent errors
                                if (!msg) return '';

                                let css = 'log-combat'; // Default red for system/combat
                                let label = 'SYSTEM';

                                if (type === 'Match Finished') {
                                    label = 'COMBAT LOG';
                                    css = 'border-l-2 border-red-500 bg-red-900/10 pl-2';

                                    // Parse Pool
                                    const poolMatch = msg.match(/Pool:\s*(\d+)/);
                                    const pool = poolMatch ? parseInt(poolMatch[1]) : 0;

                                    if (msg.includes('Winners:')) {
                                        try {
                                            // Handle "Pool: 100 XP | Winners: ID1, ID2 | Losers: ID3, ID4"
                                            const parts = msg.split('|');

                                            // Parse Winners
                                            const winnersPart = parts.find(p => p.trim().startsWith('Winners:')).split(':')[1];
                                            const winnerIds = winnersPart.split(',').map(id => id.trim()).filter(id => id);

                                            // Parse Losers
                                            const losersPart = parts.find(p => p.trim().startsWith('Losers:')).split(':')[1];
                                            const loserIds = losersPart.split(',').map(id => id.trim()).filter(id => id);

                                            // XP Calculation (Odd One Out Rule)
                                            let share = 0;
                                            if (winnerIds.length > 0) {
                                                const remainder = pool % winnerIds.length;
                                                share = (pool - remainder) / winnerIds.length;
                                            }

                                            const winnerNames = winnerIds.map(id => {
                                                const h = App.Helpers.findHunter(id);
                                                return h ? h.Name : id;
                                            }).join(', ');

                                            const loserNames = loserIds.map(id => {
                                                const h = App.Helpers.findHunter(id);
                                                return h ? h.Name : id;
                                            }).join(', ');

                                            msg = `
                                                <div class="flex flex-col gap-1">
                                                    <div class="text-yellow-400 font-bold border-b border-white/10 pb-1 mb-1">COMBAT REPORT <span class="text-gray-500 text-[10px] ml-2">(POOL: ${pool} XP)</span></div>
                                                    <div class="grid grid-cols-[auto_1fr] gap-x-2 text-[10px] md:text-xs">
                                                        <span class="text-green-500 font-bold">WINNERS:</span>
                                                        <span class="text-white">${winnerNames} <span class="text-green-400 ml-1">(+${share} XP)</span></span>
                                                        
                                                        <span class="text-red-500 font-bold">DEFEATED:</span>
                                                        <span class="text-gray-400">${loserNames}</span>
                                                    </div>
                                                </div>`;
                                        } catch (e) {
                                            console.warn("Failed to parse winner/loser details:", e);
                                            msg = msg.split('->')[0]; // Fallback
                                        }
                                    } else {
                                        msg = msg.split('->')[0];
                                    }
                                } else if (type === 'XP Update') {
                                    const hunterId = l[1];
                                    const hunter = App.Helpers.findHunter(hunterId);
                                    const hunterName = hunter ? hunter.Name : hunterId;

                                    // IMPROVED REGEX: matches "+50", "50 XP", "+ 50 XP", etc.
                                    // This ensures we catch the log even if the "+" sign is missing or formatting varies.
                                    const xpGainMatch = msg.match(/(?:\+)?\s*(\d+)\s*XP/i) || msg.match(/\+\s*(\d+)/);

                                    if (msg.includes('+') || xpGainMatch) {
                                        // 1. Standard Completion Msg
                                        label = 'CONGRATULATIONS';
                                        css = 'text-yellow-400 border-l-2 border-yellow-400 pl-2 bg-yellow-900/10';
                                        let displayMsg = `${hunterName} has completed a quest! (${msg})`;

                                        // 2. Level Up Detection Logic
                                        if (xpGainMatch && hunter) {
                                            const gainedXp = parseInt(xpGainMatch[1]);
                                            // Use hunter.XP (Total) from latest sync. 
                                            const currentXp = hunter.XP;
                                            const previousXp = Math.max(0, currentXp - gainedXp); // Prevent negative

                                            // Legendary Curve Formula: 3.16 * XP^0.4
                                            const currentLevel = Math.floor(3.16 * Math.pow(currentXp, 0.4)) + 1;
                                            const previousLevel = Math.floor(3.16 * Math.pow(previousXp, 0.4)) + 1;

                                            if (currentLevel > previousLevel) {
                                                label = 'LEVEL UP';
                                                css = 'text-cyan-400 border-l-2 border-cyan-400 pl-2 bg-cyan-900/20 shadow-[0_0_10px_rgba(34,211,238,0.3)]';
                                                displayMsg = `${hunterName} has leveled up to LEVEL ${currentLevel}!`;
                                            }
                                        }
                                        msg = displayMsg;
                                    } else {
                                        return '';
                                    }
                                }

                                return `<div class="mb-1 ${css} opacity-80 hover:opacity-100 transition-opacity text-xs md:text-sm shrink-0">
                            <span class="opacity-50 font-mono mr-2">[${time}]</span><span class="font-bold tracking-wider">${label}:</span> ${msg}
                        </div>`;
                            }).join('');
                            App.els.systemNotificationsLog.innerHTML = systemHtml;
                        }
                    },

                    showView(viewName) {
                        App.els.standby.classList.add('hidden');
                        App.els.status.classList.add('hidden');
                        App.els.vsInterface.classList.add('hidden');

                        if (viewName === 'standby') App.els.standby.classList.remove('hidden');
                        if (viewName === 'status') App.els.status.classList.remove('hidden');
                        if (viewName === 'vs') App.els.vsInterface.classList.remove('hidden');
                    }
                },

                // --- SCANNER LOGIC ---
                Scanner: {
                    start(context) {
                        console.log("Starting scanner...", context);
                        App.state.scanContext = context;
                        App.els.scannerOverlay.classList.remove('hidden');

                        const title = App.els.scannerTitle;
                        if (context === 'vs_red') {
                            title.className = "text-xl md:text-2xl font-bold text-red-500 cinzel mb-4 md:mb-8 tracking-[0.2em] md:tracking-[0.5em] animate-pulse text-center";
                            title.innerText = "REGISTRATION: RED TEAM";
                        } else if (context === 'vs_blue') {
                            title.className = "text-xl md:text-2xl font-bold text-blue-500 cinzel mb-4 md:mb-8 tracking-[0.2em] md:tracking-[0.5em] animate-pulse text-center";
                            title.innerText = "REGISTRATION: BLUE TEAM";
                        } else {
                            title.className = "text-xl md:text-2xl font-bold text-blue-400 cinzel mb-4 md:mb-8 tracking-[0.2em] md:tracking-[0.5em] animate-pulse text-center";
                            title.innerText = "SYSTEM PROCESSING";
                        }

                        if (App.state.html5QrCode) {
                            try { App.state.html5QrCode.clear(); } catch (e) { }
                        }

                        App.state.html5QrCode = new Html5Qrcode("reader");
                        App.state.html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => {
                            this.onScanSuccess(decodedText);
                        }).catch(err => {
                            console.error(err);
                            App.UI.showToast("Camera Error: " + err, true);
                            App.els.scannerOverlay.classList.add('hidden');
                        });
                    },

                    stop() {
                        // HARDWARE KILL: Stop tracks immediately to free memory/CPU
                        const videoElement = document.querySelector("#reader video");
                        if (videoElement && videoElement.srcObject) {
                            const stream = videoElement.srcObject;
                            const tracks = stream.getTracks();
                            tracks.forEach(track => track.stop());
                            videoElement.srcObject = null;
                        }

                        // Library Cleanup
                        if (App.state.html5QrCode) {
                            App.state.html5QrCode.stop().then(() => {
                                App.state.html5QrCode.clear();
                            }).catch(err => console.log("Stop error:", err));
                        }

                        App.els.scannerOverlay.classList.add('hidden');
                    },

                    onScanSuccess(decodedText) {
                        // 1. Send Data to App Inventor Blocks IMMEDIATELY
                        if (window.AppInventor) {
                            window.AppInventor.setWebViewString(decodedText);
                        }

                        // 2. Stop Camera
                        this.stop();

                        // 3. UI Logic
                        const ctx = App.state.scanContext;
                        if (ctx === 'profile') App.Profile.show(decodedText);
                        else if (ctx === 'login') App.Profile.login(decodedText);
                        else if (ctx === 'vs_red' || ctx === 'vs_blue') App.VS.processScan(decodedText, ctx);
                    }
                },

                // --- PROFILE LOGIC ---
                Profile: {
                    // Temporary View (License Scan)
                    show(hunterId) {
                        App.state.isLoggedIn = false;
                        App.state.currentHunterId = hunterId;
                        const hunter = App.Helpers.findHunter(hunterId);

                        if (!hunter) {
                            App.UI.showToast("ID NOT RECOGNIZED IN SYSTEM", true);
                            return;
                        }

                        App.UI.showToast("ACCESS GRANTED: " + hunter.Name);
                        this.render(hunter);
                        App.UI.showView('status');

                        if (App.state.profileTimeout) clearTimeout(App.state.profileTimeout);
                        App.state.profileTimeout = setTimeout(() => this.close(), 20000);
                    },

                    // Persistent View (Hunter Interface)
                    login(hunterId) {
                        localStorage.setItem('hunter_id', hunterId);
                        App.state.isLoggedIn = true;
                        App.state.currentHunterId = hunterId;
                        const hunter = App.Helpers.findHunter(hunterId);

                        if (!hunter) {
                            App.UI.showToast("ID NOT RECOGNIZED IN SYSTEM", true);
                            localStorage.removeItem('hunter_id');
                            return;
                        }

                        App.UI.showToast("LOGIN SUCCESSFUL: " + hunter.Name);
                        this.render(hunter);
                        App.UI.showView('status');

                        // NO TIMEOUT FOR LOGIN
                        if (App.state.profileTimeout) clearTimeout(App.state.profileTimeout);
                    },

                    checkPersistence() {
                        const savedId = localStorage.getItem('hunter_id');
                        if (savedId) {
                            console.log("Restoring session for:", savedId);
                            this.login(savedId);
                        }
                    },

                    close() {
                        // Just hide the view (minimize). If logged in, keep session active.
                        App.UI.showView('standby');

                        // Only clear DOM if we are fully closing a temporary scan
                        if (!App.state.isLoggedIn) {
                            App.els.status.innerHTML = '';
                        }

                        if (App.state.profileTimeout) clearTimeout(App.state.profileTimeout);
                    },

                    logout() {
                        localStorage.removeItem('hunter_id');
                        App.state.isLoggedIn = false;
                        App.UI.showToast("LOGGED OUT");
                        App.els.status.innerHTML = ''; // Clear sensitive data
                        this.close();
                    },

                    async initPhotoUpload(hunterId) {
                        // 1. Pause the auto-close timer so the profile doesn't vanish
                        if (App.state.profileTimeout) clearTimeout(App.state.profileTimeout);
                        App.UI.showToast("Select Photo...", false);

                        // 2. Create a hidden file input
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*'; // Allows Camera or Gallery

                        input.onchange = async (e) => {
                            // If user cancels, restart the timer
                            if (!e.target.files || e.target.files.length === 0) {
                                App.state.profileTimeout = setTimeout(() => App.Profile.close(), 20000);
                                return;
                            }

                            const file = e.target.files[0];
                            App.UI.showToast("Uploading Image...", false);

                            try {
                                // 3. Resize image to prevent lag
                                const base64 = await App.Helpers.resizeImage(file, 600);

                                // 4. Send to Google Sheets
                                await App.API.postVsResult('editHunter', {
                                    id: hunterId,
                                    photoBase64: base64,
                                    mimeType: file.type
                                });

                                App.UI.showToast("Photo Updated! Refreshing...");

                                // 5. Refresh data to show new photo
                                setTimeout(async () => {
                                    await App.API.refreshData();
                                    App.Profile.show(hunterId);
                                }, 2000);

                            } catch (err) {
                                console.error(err);
                                App.UI.showToast("Upload Failed.", true);
                                // Restart timer on error
                                App.state.profileTimeout = setTimeout(() => App.Profile.close(), 20000);
                            }
                        };

                        input.click(); // Open the file picker
                    },


                    async render(hunter) {
                        // NON-BLOCKING RENDER: Show UI immediately with placeholder, then fetch image
                        const defaultImg = "https://placehold.co/400x400/1e293b/ffffff?text=NO+IMAGE";

                        // Async Image Fetch (runs in background)
                        if (hunter.PhotoURL) {
                            App.Helpers.fetchImageWithRetries(App.Helpers.getDirectGdriveUrl(hunter.PhotoURL))
                                .then(blob => {
                                    const url = URL.createObjectURL(blob);
                                    const img = document.getElementById(`profile-img-${hunter.ID}`);
                                    if (img) {
                                        img.src = url;
                                        img.classList.remove('opacity-50');
                                    }
                                })
                                .catch(() => console.log("Image load failed"));
                        }

                        const completedQuests = hunter.CompletedQuests || [];
                        const allQuests = App.state.systemData.quests || [];
                        const questListHtml = allQuests.map(q => {
                            // Guild Visibility Logic: Only show quests for 'ALL' or matching hunter's guild
                            if (q.AssignedGuild && q.AssignedGuild !== 'ALL' && q.AssignedGuild !== hunter.Guild) return '';

                            const completedEntry = completedQuests.find(cq => cq.quest_id === q.ID);
                            const isCompleted = !!completedEntry;
                            const statusClass = isCompleted ? 'text-emerald-400 border-emerald-900 bg-emerald-900/20' : 'text-red-400 border-red-900 bg-red-900/20';

                            // Deadline Logic
                            let deadlineText = '';
                            if (q.Deadline) {
                                const d = new Date(q.Deadline);
                                const now = new Date();
                                const diff = d - now;

                                if (diff < 0) {
                                    deadlineText = '<div class="text-[10px] text-red-500 font-mono mt-1">STATUS: EXPIRED</div>';
                                } else {
                                    // Calculate countdown
                                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                    deadlineText = `<div class="text-[10px] text-yellow-500 font-mono mt-1">TIME LEFT: ${days}d ${hours}h ${mins}m</div>`;
                                }
                            }

                            // Guild Label
                            const guildLabel = (q.AssignedGuild && q.AssignedGuild !== 'ALL')
                                ? `<span class="text-[9px] bg-blue-900/50 text-blue-300 px-1 rounded border border-blue-800 mr-2">${q.AssignedGuild}</span>`
                                : '';

                            // Criteria List
                            let rubricHtml = '';
                            if (q.Rubrics && q.Rubrics.length > 0) {
                                rubricHtml = '<div class="mt-2 pl-2 border-l border-gray-700 space-y-1">';
                                q.Rubrics.forEach(r => {
                                    // Robust Property Access: Handle different capitalizations or potential data creep
                                    const desc = r.criterion || r.Criterion || r.description || r.Description || "Detail Undefined";
                                    const pts = r.points || r.Points || 0;
                                    rubricHtml += `<div class="flex justify-between text-[10px] text-gray-500 font-mono"><span>- ${desc}</span> <span class="text-blue-500/50">[${pts}]</span></div>`;
                                });
                                rubricHtml += '</div>';
                            }

                            return `
                    <div class="flex justify-between items-start p-3 rounded border ${statusClass} mb-2">
                        <div class="flex-grow">
                            <div class="flex items-center mb-1">
                                ${guildLabel}
                                <div class="font-bold text-xs md:text-sm text-gray-200 leading-tight">${q.Title}</div>
                            </div>
                            <div class="text-[10px] md:text-xs text-gray-500">${q.TotalXP} XP Reward</div>
                            ${deadlineText}
                            ${rubricHtml}
                        </div>
                        <div class="text-[10px] md:text-xs font-black tracking-widest ${isCompleted ? 'text-emerald-500' : 'text-red-500'} self-center ml-2">
                            ${isCompleted ? 'COMPLETE' : 'PENDING'}
                        </div>
                    </div>`;
                        }).join('') || '<div class="text-gray-500 text-center italic">No quests available.</div>';

                        // Handle SP/AP transition robustly
                        const currentAP = hunter.AP;
                        const maxAP = hunter.MaxAP;
                        const totalAPWon = hunter.TotalAPWon;

                        const currentLevel = hunter.Level;

                        // DUNGEON TOWER LOGIC (Dynamic)
                        let dungeonHtml = '';
                        if (hunter.Guild && hunter.Guild !== 'None') {
                            const guildHunters = App.state.systemData.hunters[hunter.Guild] || [];

                            // Only count Wisdom quests ASSIGNED to this hunter's guild
                            const wisdomQuests = (App.state.systemData.quests || []).filter(q =>
                                q.Category === 'WISDOM' && q.AssignedGuild === hunter.Guild
                            );
                            const totalWisdomXP = wisdomQuests.reduce((sum, q) => sum + (Number(q.TotalXP) || 0), 0);

                            // Boss HP = (Total Wisdom XP) * (Num Hunters) * 0.90
                            if (wisdomQuests.length > 0 && guildHunters.length > 0) {
                                const bossHP = Math.floor(totalWisdomXP * guildHunters.length * 0.90);
                                let damage = 0;
                                const hunterDamages = []; // Track per-hunter damage

                                guildHunters.forEach(h => {
                                    let hunterDmg = 0;
                                    const completed = h.CompletedQuests || [];
                                    completed.forEach(cq => {
                                        const q = wisdomQuests.find(wq => wq.ID === cq.quest_id);
                                        if (q) {
                                            const xp = Number(cq.xp_awarded || cq.total_xp || 0);
                                            hunterDmg += xp;
                                            damage += xp;
                                        }
                                    });

                                    if (hunterDmg > 0) {
                                        hunterDamages.push({
                                            name: h.Name || 'Unknown',
                                            damage: hunterDmg,
                                            photoUrl: h.PhotoURL || null
                                        });
                                    }
                                });

                                // Remaining HP (bar goes DOWN as damage increases)
                                const remainingHP = Math.max(0, bossHP - damage);
                                const remainingPercent = (remainingHP / bossHP) * 100;
                                const isCleared = remainingHP === 0;
                                const settings = App.state.systemData.settings || {};
                                const bossImg = settings['boss_photo'] ? App.Helpers.getDirectGdriveUrl(settings['boss_photo']) : 'https://placehold.co/600x400/581c87/ffffff?text=DUNGEON+BOSS';

                                // Build roster HTML
                                let rosterHtml = '';
                                if (hunterDamages.length > 0) {
                                    const sortedHunters = [...hunterDamages].sort((a, b) => b.damage - a.damage);
                                    const rosterRows = sortedHunters.map((h, idx) => {
                                        const photoUrl = h.photoUrl ? App.Helpers.getDirectGdriveUrl(h.photoUrl) : null;
                                        const medal = idx === 0 ? '' : (idx === 1 ? '' : (idx === 2 ? '' : ''));
                                        const pct = damage > 0 ? ((h.damage / damage) * 100).toFixed(1) : 0;
                                        return `
                                            <div class="flex items-center gap-2 py-1 border-b border-gray-800 last:border-0">
                                                <div class="text-[9px] text-gray-500 w-4 text-center">${medal || (idx + 1)}</div>
                                                <div class="w-5 h-5 rounded-full bg-gray-700 overflow-hidden flex-shrink-0">
                                                    ${photoUrl ? `<img src="${photoUrl}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[7px] text-gray-400">?</div>`}
                                                </div>
                                                <div class="flex-1 min-w-0 text-[10px] text-white truncate">${h.name}</div>
                                                <div class="text-right flex-shrink-0">
                                                    <div class="text-[10px] font-bold text-purple-400">${h.damage.toLocaleString()}</div>
                                                    <div class="text-[8px] text-gray-500">${pct}%</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');

                                    rosterHtml = `
                                        <div class="mt-2 border-t border-gray-700 pt-2">
                                            <div class="text-[9px] text-gray-400 uppercase tracking-wider font-bold mb-1"> Damage Leaderboard</div>
                                            <div class="max-h-32 overflow-y-auto">
                                                ${rosterRows}
                                            </div>
                                        </div>
                                    `;
                                }

                                dungeonHtml = `
                                <div class="mb-6 bg-gray-900 border ${isCleared ? 'border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.2)]' : 'border-purple-900/50'} rounded-lg overflow-hidden relative group shrink-0">
                                    <div class="h-28 bg-gray-800 relative">
                                        <img src="${bossImg}" class="w-full h-full object-cover opacity-60">
                                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent"></div>
                                        <div class="absolute bottom-2 left-3">
                                             <div class="text-[9px] text-purple-300 font-bold tracking-wider uppercase mb-0 shadow-black drop-shadow-md">GUILD RAID</div>
                                             <div class="text-lg font-black text-white cinzel shadow-black drop-shadow-md">${hunter.Guild} TOWER</div>
                                        </div>
                                        <div class="absolute top-2 right-2 bg-black/50 backdrop-blur px-2 py-1 rounded border border-white/10">
                                            <div class="text-[10px] text-white font-bold">${guildHunters.length} Hunters</div>
                                        </div>
                                    </div>
                                    <div class="p-3">
                                        <div class="flex justify-between text-[10px] mb-1">
                                             <span class="text-gray-400">BOSS HP</span>
                                             <span class="text-white font-mono">${remainingHP.toLocaleString()} / ${bossHP.toLocaleString()}</span>
                                        </div>
                                        <div class="h-3 bg-gray-950 rounded-full overflow-hidden border border-gray-700 relative">
                                             <div class="h-full ${isCleared ? 'bg-yellow-500' : 'bg-red-600'} transition-all duration-1000 relative" style="width: ${remainingPercent}%">
                                                  <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                             </div>
                                        </div>
                                        <div class="flex justify-between items-center mt-2">
                                             <div class="text-[10px] text-gray-500 italic">DMG Dealt: <span class="text-purple-400 font-bold">${damage.toLocaleString()}</span></div>
                                             ${isCleared ? '<div class="text-xs font-bold text-yellow-400"> CLEARED</div>' : ''}
                                        </div>
                                        ${rosterHtml}
                                    </div>
                                </div>`;
                            } else if (wisdomQuests.length === 0) {
                                // INACTIVE STATE
                                const settings = App.state.systemData.settings || {};
                                const bossImg = settings['boss_photo'] ? App.Helpers.getDirectGdriveUrl(settings['boss_photo']) : 'https://placehold.co/600x400/581c87/ffffff?text=DUNGEON+BOSS';

                                dungeonHtml = `
                                <div class="mb-6 bg-gray-900 border border-gray-800 rounded-lg overflow-hidden relative group shrink-0 opacity-60 grayscale">
                                    <div class="h-28 bg-gray-800 relative">
                                        <img src="${bossImg}" class="w-full h-full object-cover opacity-40">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                             <div class="text-xs text-gray-400 font-bold uppercase tracking-widest border border-gray-600 px-3 py-1 rounded bg-black/50">TOWER LOCKED</div>
                                        </div>
                                        <div class="absolute bottom-2 left-3">
                                             <div class="text-[9px] text-gray-500 font-bold tracking-wider uppercase mb-0">GUILD RAID</div>
                                             <div class="text-lg font-black text-gray-400 cinzel">${hunter.Guild} TOWER</div>
                                        </div>
                                    </div>
                                    <div class="p-3 text-center">
                                        <div class="text-[10px] text-gray-500 italic">Awaiting WISDOM Quests...</div>
                                    </div>
                                </div>`;
                            }
                        }

                        // Pre-compute tab-dependent classes
                        const statsClass = App.state.activeTab !== 'quests' ? 'flex flex-col md:flex-row gap-4 md:gap-8' : 'hidden';
                        const questsClass = App.state.activeTab === 'quests' ? 'flex flex-col min-h-0 flex-1' : 'hidden';
                        const statsBtnClass = App.state.activeTab !== 'quests' ? 'text-white border-blue-500' : 'text-gray-500 border-transparent';
                        const questsBtnClass = App.state.activeTab === 'quests' ? 'text-white border-blue-500' : 'text-gray-500 border-transparent hover:text-white';

                        const html = `
                <div class="bg-gray-900/95 md:bg-gray-900/90 border border-gray-700 p-4 md:p-8 rounded-none md:rounded-2xl shadow-2xl backdrop-blur-md relative overflow-hidden animate-fade-in-up min-h-full md:min-h-0" id="profile-container">
                    ${!App.state.isLoggedIn ?
                                `<button onclick="App.Profile.close()" class="absolute top-4 right-4 text-gray-500 hover:text-white hover:bg-red-600/50 rounded-full w-8 h-8 flex items-center justify-center transition-all z-50 border border-transparent hover:border-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>` : ''
                            }
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-purple-500 to-blue-600 animate-pulse"></div>
                    
                    <div class="flex justify-between items-center mb-4 md:mb-6 border-b border-gray-700 pb-4 gap-4">
                        <div class="flex flex-col items-start gap-2">
                             ${App.state.isLoggedIn ?
                                `<button onclick="App.Profile.close()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white px-3 py-1.5 rounded-full text-[10px] md:text-xs font-bold border border-gray-600 flex items-center gap-2 transition-colors group">
                                    <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                    BACK TO MENU
                                </button>` : ''
                            }
                            <div class="text-[10px] md:text-xs text-gray-500 font-mono">ID: ${hunter.ID} // <span class="text-blue-400 animate-pulse">ONLINE</span></div>
                        </div>
                        <div class="flex gap-2 md:gap-4 pr-0 md:pr-8">
                            <button onclick="App.Profile.switchTab('stats')" id="btn-stats" class="text-sm font-bold ${statsBtnClass} uppercase border-b-2 px-2 py-1 transition-colors">STATUS</button>
                            <button onclick="App.Profile.switchTab('quests')" id="btn-quests" class="text-sm font-bold ${questsBtnClass} uppercase border-b-2 px-2 py-1 transition-colors">MISSIONS</button>
                        </div>
                    </div>

                    <div class="${statsClass}" id="view-stats">
                        <div class="w-full md:w-1/3 flex flex-row md:flex-col gap-4 md:gap-0 items-center md:items-stretch">
                            <div class="w-1/3 md:w-full aspect-square bg-gray-800 rounded-xl overflow-hidden border-2 border-gray-600 shadow-[0_0_15px_rgba(0,0,0,0.5)] mb-0 md:mb-4 relative shrink-0">
                                <img id="profile-img-${hunter.ID}" src="${defaultImg}" class="w-full h-full object-cover opacity-50 transition-opacity duration-500">
<button onclick="App.Profile.initPhotoUpload('${hunter.ID}')" class="absolute bottom-2 right-2 bg-black/60 hover:bg-blue-600 text-white p-2 rounded-full backdrop-blur-md border border-white/20 shadow-lg z-20 transition-all cursor-pointer group">
                                <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                            </div>
                            <div class="text-left md:text-center mt-0 md:mt-2">
                                <div class="text-[10px] md:text-xs text-gray-500 font-bold uppercase tracking-widest mb-1">Current Evaluation</div>
                                <div class="flex items-baseline justify-start md:justify-center gap-2">
                                    <div class="text-6xl md:text-8xl font-black cinzel rank-${hunter.Rank.toLowerCase()} leading-none drop-shadow-xl">${hunter.Rank}</div>
                                    <div class="text-xl md:text-2xl font-bold text-blue-500 font-mono">LVL ${currentLevel}</div>
                                </div>
                            </div>
                        </div>

                        <div class="w-full md:w-2/3 flex flex-col justify-center pl-0 md:pl-4">
                            <h1 class="text-4xl md:text-6xl font-black text-white uppercase mb-2 leading-none tracking-tighter drop-shadow-lg break-words">${hunter.Name}</h1>
                            <div class="flex flex-wrap items-center gap-2 md:gap-4 mb-6 md:mb-10">
                                <span class="bg-blue-900/30 text-blue-200 px-4 py-1.5 rounded-sm text-xs md:text-sm font-bold border border-blue-500/50 tracking-wider shadow-[0_0_10px_rgba(37,99,235,0.2)]">${hunter.Guild}</span>
                                <span class="text-xl md:text-2xl text-gray-400 font-mono uppercase tracking-widest border-l border-gray-700 pl-4">${hunter.Job}</span>
                            </div>
                            <div class="space-y-6 md:space-y-8">
                                <div>
                                    <div class="flex justify-between text-blue-400 font-bold text-xs md:text-sm mb-2 tracking-widest">
                                        <span>EXPERIENCE</span>
                                        <span class="text-white font-mono">${hunter.XP} XP</span>
                                    </div>
                                    <div class="h-4 md:h-6 bg-gray-900 rounded-sm overflow-hidden border border-gray-700 shadow-inner">
                                        <div class="h-full bg-blue-600 shadow-[0_0_20px_rgba(37,99,235,0.6)] relative overflow-hidden" style="width: ${(hunter.XP % 500) / 5}%">
                                            <div class="absolute inset-0 bg-white/20 w-full h-full animate-pulse"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-emerald-400 font-bold text-xs md:text-sm mb-2 tracking-widest">
                                        <span>ACTION POINTS (AP)</span>
                                        <span class="text-white font-mono">${currentAP} / ${maxAP}</span>
                                    </div>
                                    <div class="h-4 md:h-6 bg-gray-900 rounded-sm overflow-hidden border border-gray-700 shadow-inner">
                                        <div class="h-full bg-emerald-600 shadow-[0_0_20px_rgba(5,150,105,0.6)]" style="width: ${(currentAP / maxAP) * 100}%"></div>
                                    </div>
                                </div>
                                <div class="text-right text-[10px] md:text-xs text-gray-500 pt-2">Total Combat Winnings: <span class="text-yellow-400 font-mono">${totalAPWon} XP</span></div>
                            </div>

                            <!-- Academic Performance Panel (NEW) -->
                            <div class="mt-6 pt-4 border-t border-gray-800">
                                <div class="text-[10px] text-gray-500 uppercase font-bold mb-3 tracking-widest"> Academic Performance</div>
                                
                                <!-- 1. Rating (Feature Banner) -->
                                <div class="flex flex-col items-center justify-center mb-3 p-4 bg-gray-900/80 rounded border border-gray-800 text-center relative overflow-hidden group">
                                    <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div class="text-[10px] text-gray-500 uppercase font-bold mb-1 tracking-widest z-10">Overall Rating</div>
                                    <div id="ht-sealed-rating" class="text-3xl font-black z-10 ${(() => {
                                const rating = App.Helpers.calculateRating(hunter);
                                if (rating >= 90) return 'text-yellow-400';
                                if (rating >= 75) return 'text-blue-400';
                                return 'text-red-500 animate-pulse';
                            })()}">${App.Helpers.calculateRating(hunter).toFixed(1)}%</div>
                                </div>

                                <!-- 2. Charts (Stacked for Mobile Visibility) -->
                                <div class="space-y-3 mb-3">
                                    <div class="bg-gray-900 rounded p-3 border border-gray-800">
                                        <div class="text-[9px] text-gray-500 uppercase font-bold mb-2"> Trajectory</div>
                                        <div class="h-32">
                                            <canvas id="ht-trajectory-chart"></canvas>
                                        </div>
                                    </div>
                                    <div class="bg-gray-900 rounded p-3 border border-gray-800">
                                        <div class="text-[9px] text-gray-500 uppercase font-bold mb-2"> Hunter Build</div>
                                        <div class="h-40">
                                            <canvas id="ht-radar-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 3. Stats Breakdown (3-Column Grid) -->
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    ${(() => {
                                const stats = App.Helpers.getCategoryStats(hunter);
                                return `
                                            <div class="bg-gray-900 rounded p-2 text-center border border-gray-800">
                                                <div class="text-[9px] text-gray-500 uppercase mb-1"> Know</div>
                                                <div class="text-sm font-bold text-blue-400">${stats.knowledge.toFixed(0)}%</div>
                                                <div class="text-[8px] text-gray-600">20%</div>
                                            </div>
                                            <div class="bg-gray-900 rounded p-2 text-center border border-gray-800">
                                                <div class="text-[9px] text-gray-500 uppercase mb-1"> Skill</div>
                                                <div class="text-sm font-bold text-red-400">${stats.skills.toFixed(0)}%</div>
                                                <div class="text-[8px] text-gray-600">60%</div>
                                            </div>
                                            <div class="bg-gray-900 rounded p-2 text-center border border-gray-800">
                                                <div class="text-[9px] text-gray-500 uppercase mb-1"> Wis</div>
                                                <div class="text-sm font-bold text-yellow-400">${stats.wisdom.toFixed(0)}%</div>
                                                <div class="text-[8px] text-gray-600">20%</div>
                                            </div>
                                        `;
                            })()}
                                </div>

                                <!-- 4. Wisdom Simulator -->
                                <div class="bg-gray-900/80 rounded p-3 border border-gray-800">
                                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-2"> Exam Simulator</div>
                                    <div class="flex items-center gap-2">
                                        <input type="range" id="ht-wisdom-sim" min="0" max="100" value="${App.Helpers.getCategoryStats(hunter).wisdom}" 
                                            class="flex-1 accent-yellow-500" 
                                            oninput="App.Helpers.updateSimulation(this.value, '${hunter.ID}')">
                                        <span id="ht-wisdom-val" class="text-xs text-yellow-400 font-mono w-10 text-right">${App.Helpers.getCategoryStats(hunter).wisdom.toFixed(0)}%</span>
                                        <span id="ht-sim-rating" class="text-[10px] text-yellow-400/50 font-bold ml-1 min-w-[3rem]">--%</span>
                                    </div>
                                    <div class="text-[9px] text-gray-600 mt-1 italic text-center">"If I score X% on the exam..."</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="${questsClass}" id="view-quests">
                        <h2 class="text-xl md:text-2xl font-black text-white cinzel mb-4">ACTIVE MISSIONS</h2>
                        ${dungeonHtml}
                        <div class="overflow-y-auto pr-2 quest-scroll flex-grow">${questListHtml}</div>
                    </div>
                    
                    ${App.state.isLoggedIn ? `
                        <div id="logout-trigger" class="mt-8 mb-4 flex justify-center opacity-0 transition-opacity duration-500">
                            <button onclick="App.Profile.logout()" class="bg-red-900/20 hover:bg-red-900/50 border border-red-900/50 text-red-500 px-6 py-2 rounded uppercase text-xs font-bold tracking-widest transition-all">
                                Log Out
                            </button>
                        </div>
                    ` : ''}
                </div>`;

                        App.els.status.innerHTML = html;

                        // Scroll Logic for Logout Trigger
                        if (App.state.isLoggedIn) {
                            const container = document.getElementById('profile-container');
                            const logoutBtn = document.getElementById('logout-trigger');
                            if (container && logoutBtn) {
                                // For full-page mobile view (where container is h-full), we need to check if the scroll is on body or container?
                                // Actually, in mobile view (p-4 min-h-full), typical scrolling is on the body if specific element isn't overflow-y-auto.
                                // Let's check CSS: 'safe-bottom' on standby. Line 1087: min-h-full md:min-h-0.
                                // It seems the main content scrolls on BODY or App.els.status?
                                // App.els.status is defined where? line 1230 inserts into it.

                                // Since we are in a single-page app, scrolling usually happens on a container.
                                // If not, we can attach to window.
                                // Let's attach to the container first.

                                // Actually, let's use IntersectionObserver which is cleaner for "reached bottom".
                                const observer = new IntersectionObserver((entries) => {
                                    entries.forEach(entry => {
                                        if (entry.isIntersecting) {
                                            logoutBtn.classList.remove('opacity-0');
                                        }
                                    });
                                }, { threshold: 0.5 });
                                observer.observe(logoutBtn);
                            }
                        }

                        // Render charts after DOM is updated
                        setTimeout(() => App.Helpers.renderCharts(hunter), 100);
                    },

                    switchTab(tabName) {
                        App.state.activeTab = tabName; // Update State

                        const stats = document.getElementById('view-stats');
                        const quests = document.getElementById('view-quests');
                        const btnStats = document.getElementById('btn-stats');
                        const btnQuests = document.getElementById('btn-quests');

                        if (tabName === 'stats') {
                            // Show Stats, Hide Quests
                            stats.className = 'flex flex-col md:flex-row gap-4 md:gap-8';
                            quests.className = 'hidden';

                            // Activate Stats Button
                            btnStats.classList.add('text-white', 'border-blue-500');
                            btnStats.classList.remove('text-gray-500', 'border-transparent');

                            // Deactivate Quests Button
                            btnQuests.classList.remove('text-white', 'border-blue-500');
                            btnQuests.classList.add('text-gray-500', 'border-transparent');
                        } else {
                            // Hide Stats, Show Quests
                            stats.className = 'hidden';
                            quests.className = 'flex flex-col min-h-0 flex-1';

                            // Deactivate Stats Button
                            btnStats.classList.remove('text-white', 'border-blue-500');
                            btnStats.classList.add('text-gray-500', 'border-transparent');

                            // Activate Quests
                            btnQuests.classList.add('text-white', 'border-blue-500');
                            btnQuests.classList.remove('text-gray-500', 'border-transparent');
                        }
                    }
                },

                // --- VS MODE LOGIC ---
                VS: {
                    enterMode() {
                        App.UI.showView('vs');
                        this.renderSetup();
                    },

                    exitMode() {
                        App.UI.showView('standby');
                        // CLEANUP: Clear the heavy VS interface to free memory immediately
                        App.els.vsInterface.innerHTML = '';
                        App.state.vs = { active: false, format: 0, redTeam: [], blueTeam: [], activeSlot: null, phase: 'setup', pool: 0, pendingScan: null };
                    },

                    renderSetup() {
                        const ui = App.els.vsInterface;
                        ui.innerHTML = `
                <div class="w-full max-w-4xl p-4 md:p-8 pb-24 md:pb-8 animate-fade-in-up flex flex-col items-center justify-center h-full overflow-y-auto safe-bottom">
                    <h1 class="text-3xl md:text-6xl font-black text-white cinzel text-center mb-2 mt-auto md:mt-0">VERSUS PROTOCOL</h1>
                    <p class="text-center text-red-500 font-mono text-xs md:text-base tracking-widest mb-4 md:mb-12">SELECT COMBAT CONFIGURATION</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-6 mb-4 md:mb-12 w-full max-w-sm md:max-w-none">
                        ${[1, 2, 4, 5, 6].map(n => `
                            <button onclick="App.VS.initMatch(${n})" class="bg-gray-900 hover:bg-red-900/50 border border-gray-700 hover:border-red-500 py-4 md:py-8 rounded-lg transition-all group relative overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-br from-transparent to-red-900/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="text-2xl md:text-4xl font-black text-white cinzel relative z-10">${n} VS ${n}</div>
                                <div class="hidden md:block text-xs text-gray-500 font-mono mt-2 group-hover:text-red-300">STANDARD MATCH</div>
                            </button>
                        `).join('')}
                        
                        <button onclick="App.VS.showLeaderboard()" class="bg-gray-900 hover:bg-yellow-900/50 border border-gray-700 hover:border-yellow-500 py-4 md:py-8 rounded-lg transition-all group">
                            <div class="text-2xl md:text-4xl font-black text-yellow-500 cinzel">RANKING</div>
                            <div class="hidden md:block text-xs text-gray-500 font-mono mt-2 group-hover:text-yellow-300">COMBAT LEADERBOARD</div>
                        </button>
                    </div>
                    
                    <div class="text-center mb-auto md:mb-0">
                        <button onclick="App.VS.exitMode()" class="text-gray-500 hover:text-white uppercase font-bold tracking-widest text-xs md:text-sm p-4">Return to Main Menu</button>
                    </div>
                </div>`;
                    },

                    showLeaderboard() {
                        const allHunters = [];
                        if (App.state.systemData.hunters) {
                            for (const [guild, list] of Object.entries(App.state.systemData.hunters)) {
                                list.forEach(h => {
                                    const won = h.TotalAPWon;
                                    allHunters.push({ ...h, Guild: guild, _won: won });
                                });
                            }
                        }
                        const filteredHunters = allHunters.filter(h => h._won > 0);
                        filteredHunters.sort((a, b) => b._won - a._won);
                        const top10 = filteredHunters.slice(0, 10);

                        const ui = App.els.vsInterface;
                        ui.innerHTML = `
                <div class="absolute inset-0 z-50 bg-black flex flex-col p-4 md:p-8 animate-fade-in-up safe-bottom">
                    <button onclick="App.VS.renderSetup()" class="absolute top-2 right-2 md:-top-4 md:-right-4 z-50 bg-gray-900 text-gray-400 hover:text-white hover:bg-red-900 border border-gray-700 hover:border-red-500 font-bold p-2 md:p-3 rounded-full shadow-lg transition-all">
                        <svg class="w-4 h-4 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <h1 class="text-3xl md:text-5xl font-black text-yellow-500 cinzel text-center mb-4 md:mb-8 drop-shadow-lg shrink-0">COMBAT RANKINGS</h1>
                    <div class="bg-gray-900/90 border border-yellow-900/50 rounded-xl overflow-hidden shadow-2xl flex-grow overflow-y-auto custom-scroll w-full max-w-4xl mx-auto">
                        <table class="w-full text-left">
                            <thead class="bg-black/50 text-yellow-600 uppercase text-[10px] md:text-xs font-bold tracking-wider sticky top-0 backdrop-blur-sm z-10">
                                <tr><th class="p-2 md:p-4 text-center">#</th><th class="p-2 md:p-4">Hunter</th><th class="p-2 md:p-4 text-right">XP Won</th></tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                ${top10.length > 0 ? top10.map((h, i) => `
                                    <tr class="hover:bg-yellow-900/10">
                                        <td class="p-2 md:p-4 text-center font-bold text-gray-400 text-sm md:text-base">${i + 1}</td>
                                        <td class="p-2 md:p-4 flex items-center gap-2 md:gap-3">
                                            <div class="w-8 h-8 md:w-8 md:h-8 rounded bg-gray-800 overflow-hidden border border-gray-700 shrink-0">
                                                <img data-src="${h.PhotoURL || ''}" src="https://placehold.co/100x100/1f2937/4b5563?text=..." class="leaderboard-photo w-full h-full object-cover">
                                            </div>
                                            <div class="min-w-0">
                                                <div class="font-bold text-white text-xs md:text-base truncate">${h.Name}</div>
                                                <div class="text-[8px] md:text-[10px] text-gray-500 uppercase tracking-wider truncate">${h.Guild || 'Unknown Guild'}</div>
                                            </div>
                                        </td>
                                        <td class="p-2 md:p-4 text-right font-mono text-yellow-400 font-bold text-sm md:text-lg">${h._won}</td>
                                    </tr>`).join('') : `<tr><td colspan="3" class="p-8 text-center text-gray-500 italic text-sm">No combat data available.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>`;
                        setTimeout(() => { App.Helpers.processImages('.leaderboard-photo'); }, 100);
                    },

                    initMatch(n) {
                        App.state.vs = {
                            active: true,
                            format: n,
                            redTeam: Array(n).fill(null),
                            blueTeam: Array(n).fill(null),
                            phase: 'reg',
                            pool: 0,
                            pendingScan: null
                        };
                        this.renderRegistration();
                    },

                    renderRegistration() {
                        const ui = App.els.vsInterface;
                        const minReq = App.state.vs.format;

                        const redTotal = App.state.vs.redTeam.reduce((sum, h) => sum + (h ? h.stake : 0), 0);
                        const blueTotal = App.state.vs.blueTeam.reduce((sum, h) => sum + (h ? h.stake : 0), 0);

                        const redFilled = App.state.vs.redTeam.every(h => h !== null);
                        const blueFilled = App.state.vs.blueTeam.every(h => h !== null);

                        // Start Condition: All slots must be filled AND Total AP per team must meet the requirement
                        const canStart = redFilled && blueFilled && redTotal >= minReq && blueTotal >= minReq;
                        App.state.vs.pool = redTotal + blueTotal;

                        const renderSlot = (team, idx, data, context) => {
                            if (!data) {
                                return `<div onclick="App.Scanner.start('${context}'); App.state.vs.activeSlot={team:'${team}', index:${idx}};" 
                                class="h-14 md:h-24 bg-gray-900/50 border-2 border-dashed border-gray-700 hover:border-${team === 'red' ? 'red' : 'blue'}-500 rounded-lg flex flex-col items-center justify-center cursor-pointer group transition-all">
                                <div class="text-xl md:text-2xl text-gray-600 group-hover:text-white">+</div>
                            </div>`;
                            }
                            return `<div class="h-14 md:h-24 bg-gray-800 border-l-4 border-${team === 'red' ? 'red' : 'blue'}-500 rounded-r-lg p-2 md:p-3 flex justify-between items-center relative overflow-hidden group">
                                <button onclick="App.VS.removeHunter('${team}', ${idx})" class="absolute top-0 right-0 text-gray-600 hover:text-red-500 text-lg font-bold z-10 p-2 leading-none">&times;</button>
                                <div>
                                    <div class="font-bold text-white leading-none text-xs md:text-base">${data.name}</div>
                                    <div class="text-[10px] text-gray-400 mt-0.5 md:mt-1">AP: <span class="text-white font-bold">${data.stake}</span></div>
                                </div>
                            </div>`;
                        };

                        ui.innerHTML = `
                <div class="fixed inset-0 z-50 bg-black flex flex-col p-2 md:p-4 pb-20 md:pb-4 safe-bottom">
                    <h1 class="shrink-0 text-xl md:text-3xl font-black text-center cinzel text-gray-400 mb-2 md:mb-6">REGISTRATION <span class="text-blue-500">${App.state.vs.format}v${App.state.vs.format}</span></h1>
                    
                    <div class="flex-grow flex flex-col md:flex-row gap-2 md:gap-8 overflow-hidden min-h-0">
                        <div class="flex-1 bg-red-950/20 border border-red-900/50 rounded-xl p-2 md:p-6 relative flex flex-col min-h-0">
                            <div class="shrink-0 flex justify-between items-center mb-2">
                                <div class="text-red-500 font-bold text-xs tracking-widest">RED TEAM</div>
                                <div class="${redTotal >= minReq ? 'text-green-400' : 'text-red-500'} font-bold text-xs">TOTAL: ${redTotal} / ${minReq} AP</div>
                            </div>
                            <div class="overflow-y-auto custom-scroll flex-grow pr-1 space-y-2">
                                ${App.state.vs.redTeam.map((h, i) => renderSlot('red', i, h, 'vs_red')).join('')}
                            </div>
                        </div>

                        <div class="flex-1 bg-blue-950/20 border border-blue-900/50 rounded-xl p-2 md:p-6 relative flex flex-col min-h-0">
                            <div class="shrink-0 flex justify-between items-center mb-2">
                                <div class="text-blue-500 font-bold text-xs tracking-widest">BLUE TEAM</div>
                                <div class="${blueTotal >= minReq ? 'text-green-400' : 'text-red-500'} font-bold text-xs">TOTAL: ${blueTotal} / ${minReq} AP</div>
                            </div>
                            <div class="overflow-y-auto custom-scroll flex-grow pr-1 space-y-2">
                                ${App.state.vs.blueTeam.map((h, i) => renderSlot('blue', i, h, 'vs_blue')).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="shrink-0 mt-2 md:mt-6 border-t border-gray-800 md:border-none pt-2 md:pt-0 pb-4">
                        <div class="flex items-center justify-between md:justify-center md:flex-col mb-2">
                            <div class="text-[10px] md:text-xs text-gray-500 uppercase tracking-widest md:mb-1">POOL</div>
                            <div class="text-2xl md:text-4xl font-black text-yellow-400 cinzel text-shadow-glow">${App.state.vs.pool} XP</div>
                        </div>
                        
                        <div class="flex gap-2 justify-center">
                            <button onclick="App.VS.quitGame()" class="flex-1 md:flex-none px-4 py-3 md:px-6 border border-gray-600 text-gray-400 hover:text-white rounded text-xs md:text-sm font-bold uppercase">CANCEL</button>
                            <button onclick="App.VS.startBattle()" ${canStart ? '' : 'disabled'} class="flex-[2] md:flex-none px-6 py-3 md:px-12 bg-gradient-to-r from-red-600 to-blue-600 hover:from-red-500 hover:to-blue-500 text-white font-black text-sm md:text-lg tracking-widest rounded shadow-lg transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                                INITIATE
                            </button>
                        </div>
                    </div>
                </div>`;
                    },

                    // --- SCAN PROCESSING (Uses Custom Overlay, No Prompts) ---
                    processScan(id, context) {
                        const hunter = App.Helpers.findHunter(id);
                        if (!hunter) return App.UI.showToast("Hunter not found.", true);

                        const isRed = App.state.vs.redTeam.some(h => h && h.id === id);
                        const isBlue = App.state.vs.blueTeam.some(h => h && h.id === id);
                        if (isRed || isBlue) return App.UI.showToast("Hunter already registered.", true);

                        // Prepare and show AP Input Overlay (Renamed from SP)
                        App.state.vs.pendingScan = { hunter, context };

                        App.els.apInputName.textContent = hunter.Name;
                        App.els.apInputAvailable.textContent = hunter.AP !== undefined ? hunter.AP : hunter.SP;
                        App.els.apInputField.value = '';

                        App.els.apInputOverlay.classList.remove('hidden');
                        App.els.apInputField.focus();
                    },

                    submitApInput() {
                        const amount = parseInt(App.els.apInputField.value);
                        const { hunter, context } = App.state.vs.pendingScan;
                        const hunterAP = hunter.AP !== undefined ? hunter.AP : hunter.SP;

                        if (isNaN(amount) || amount < 1) return App.UI.showToast("Invalid Amount (Min 1 AP)", true);
                        if (hunterAP < amount) return App.UI.showToast("Insufficient AP", true);

                        const entry = { id: hunter.ID, name: hunter.Name, stake: amount, rank: hunter.Rank };
                        if (context === 'vs_red' && App.state.vs.activeSlot.team === 'red') {
                            App.state.vs.redTeam[App.state.vs.activeSlot.index] = entry;
                        } else if (context === 'vs_blue' && App.state.vs.activeSlot.team === 'blue') {
                            App.state.vs.blueTeam[App.state.vs.activeSlot.index] = entry;
                        }

                        this.cancelApInput();
                        this.renderRegistration();
                    },

                    cancelApInput() {
                        App.state.vs.pendingScan = null;
                        App.els.apInputOverlay.classList.add('hidden');
                    },

                    removeHunter(team, idx) {
                        if (team === 'red') App.state.vs.redTeam[idx] = null;
                        else App.state.vs.blueTeam[idx] = null;
                        this.renderRegistration();
                    },

                    startBattle() {
                        App.state.vs.phase = 'battle';
                        App.els.vsInterface.innerHTML = `
                <div class="w-full h-full flex flex-col items-center justify-center animate-pulse p-4 pb-20 safe-bottom">
                    <h1 class="text-4xl md:text-6xl font-black text-red-500 cinzel mb-6 md:mb-8 tracking-tighter text-center">COMBAT IN PROGRESS</h1>
                    <div class="text-xl md:text-2xl text-gray-400 font-mono mb-8 md:mb-12">PRIZE POOL: <span class="text-yellow-400">${App.state.vs.pool} XP</span></div>
                    <div class="flex flex-col md:flex-row gap-4 md:gap-8 w-full md:w-auto">
                        <button onclick="App.VS.finishGame()" class="bg-green-700 hover:bg-green-600 text-white px-8 py-4 rounded font-bold text-lg md:text-xl uppercase tracking-widest shadow-[0_0_20px_rgba(22,163,74,0.5)] w-full md:w-auto">GAME FINISH</button>
                        <button onclick="App.VS.quitGame()" class="bg-red-900/50 hover:bg-red-800 border border-red-700 text-red-200 px-8 py-4 rounded font-bold text-lg md:text-xl uppercase tracking-widest w-full md:w-auto">QUIT GAME</button>
                    </div>
                    <p class="mt-8 text-gray-600 text-[10px] md:text-xs">WARNING: Quitting applies AP penalty to both teams.</p>
                </div>`;
                    },

                    finishGame() {
                        const ui = App.els.vsInterface;
                        const modal = document.createElement('div');
                        modal.innerHTML = `
                <div class="absolute inset-0 bg-black/90 z-50 flex items-center justify-center p-4 safe-bottom">
                    <div class="bg-gray-900 border border-gray-700 p-6 md:p-8 rounded-xl text-center max-w-lg w-full">
                        <h2 class="text-2xl font-bold text-white mb-6">CONFIRM VICTOR</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="App.VS.submitResult('red')" class="bg-red-700 hover:bg-red-600 text-white py-6 rounded font-black text-lg md:text-xl hover:scale-105 transition-transform">RED TEAM</button>
                            <button onclick="App.VS.submitResult('blue')" class="bg-blue-700 hover:bg-blue-600 text-white py-6 rounded font-black text-lg md:text-xl hover:scale-105 transition-transform">BLUE TEAM</button>
                        </div>
                        <button onclick="App.VS.startBattle()" class="mt-6 text-gray-500 hover:text-white underline p-4">Cancel</button>
                    </div>
                </div>`;
                        ui.appendChild(modal.firstElementChild);
                    },

                    // --- QUIT GAME LOGIC (Updated to use Overlay) ---
                    quitGame() {
                        // Show custom overlay instead of blocking confirm()
                        if (App.state.vs.phase === 'battle') {
                            // During battle: show warning
                            App.els.quitOverlay.classList.remove('hidden');
                        } else {
                            // During registration: just exit
                            this.exitMode();
                        }
                    },

                    confirmQuit() {
                        App.els.quitOverlay.classList.add('hidden');

                        const redIds = App.state.vs.redTeam.map(h => h.id);
                        const blueIds = App.state.vs.blueTeam.map(h => h.id);
                        App.API.postVsResult('vsMatchQuit', { teamRed: redIds, teamBlue: blueIds });

                        App.UI.showToast("MATCH TERMINATED. PENALTIES APPLIED.", true);
                        this.exitMode();
                        setTimeout(() => App.API.refreshData(), 2000);
                    },

                    cancelQuit() {
                        App.els.quitOverlay.classList.add('hidden');
                    },

                    submitResult(winner) {
                        const winners = winner === 'red' ? App.state.vs.redTeam.map(h => h.id) : App.state.vs.blueTeam.map(h => h.id);
                        const losers = winner === 'red' ? App.state.vs.blueTeam.map(h => h.id) : App.state.vs.redTeam.map(h => h.id);
                        const stakes = {};
                        [...App.state.vs.redTeam, ...App.state.vs.blueTeam].forEach(h => { if (h) stakes[h.id] = h.stake; });

                        App.els.vsInterface.innerHTML = `
                <div class="w-full h-full flex flex-col items-center justify-center">
                    <h1 class="text-4xl md:text-6xl font-black text-${winner === 'red' ? 'red' : 'blue'}-500 cinzel mb-4 animate-bounce text-center">VICTORY</h1>
                    <p class="text-white text-lg md:text-xl">UPDATING HUNTER RECORDS...</p>
                </div>`;

                        App.API.postVsResult('vsMatchComplete', { winners, losers, pool: App.state.vs.pool, stakes })
                            .then(() => {
                                App.UI.showToast("RECORDS UPDATED. XP DISTRIBUTED.");
                                this.exitMode();

                                // OPTIMIZATION: Delay data sync to ensure UI transition completes smoothly without freezing
                                setTimeout(() => {
                                    App.API.refreshData();
                                }, 500);
                            }).catch(e => {
                                App.UI.showToast("Connection Error. Check Logs.", true);
                                this.exitMode();
                            });
                    }
                },

                // --- HELPERS ---
                Helpers: {
                    findHunter(id) {
                        if (App.state.systemData.hunters) {
                            for (const [sec, list] of Object.entries(App.state.systemData.hunters)) {
                                const found = list.find(h => h.ID === id);
                                if (found) return { ...found, Guild: sec };
                            }
                        }
                        return null;
                    },

                    normalizeData(data) {
                        if (!data.hunters) return;

                        // Helper to safely parse JSON or return default
                        const safeParse = (val, def) => {
                            if (typeof val === 'string') {
                                try { return JSON.parse(val); } catch (e) { return def; }
                            }
                            return Array.isArray(val) ? val : def;
                        };

                        for (const section in data.hunters) {
                            data.hunters[section].forEach(h => {
                                h.CompletedQuests = safeParse(h.CompletedQuests, []);
                                h.CombatHistory = safeParse(h.CombatHistory, []);

                                if (!h.ArchitectComment) h.ArchitectComment = "";

                                // Normalize AP/SP
                                if (h.AP === undefined && h.SP !== undefined) h.AP = h.SP;
                                if (h.MaxAP === undefined && h.MaxSP !== undefined) h.MaxAP = h.MaxSP;
                                h.TotalAPWon = Number(h.TotalAPWon !== undefined ? h.TotalAPWon : (h.TotalSPWon || 0));

                                // Calculate Level
                                h.XP = Number(h.XP || 0);
                                h.Level = Math.floor(3.16 * Math.pow(h.XP, 0.4)) + 1;
                            });
                        }
                        if (data.quests) {
                            data.quests.forEach(q => {
                                q.Rubrics = safeParse(q.Rubrics, []);
                            });
                        }
                        if (!data.logs) data.logs = [];
                    },

                    // --- ANALYTICS FUNCTIONS (Hunter Education Initiative) ---
                    K_WEIGHT: 0.20,
                    S_WEIGHT: 0.60,
                    W_WEIGHT: 0.20,

                    getCategoryStats(hunter) {
                        const completedQuests = hunter.CompletedQuests || [];
                        const allQuests = App.state.systemData?.quests || [];

                        let kTotal = 0, kMax = 0, sTotal = 0, sMax = 0, wTotal = 0, wMax = 0;

                        completedQuests.forEach(cq => {
                            const quest = allQuests.find(q => q.ID === cq.quest_id);
                            if (!quest) return;

                            const category = quest.Category || 'SKILLS';
                            const earnedScore = Number(cq.xp_awarded || cq.total_xp || 0);
                            const maxScore = Number(quest.TotalXP || 0);

                            if (category === 'KNOWLEDGE') { kTotal += earnedScore; kMax += maxScore; }
                            else if (category === 'WISDOM') { wTotal += earnedScore; wMax += maxScore; }
                            else if (category !== 'SIDE') { sTotal += earnedScore; sMax += maxScore; }
                        });

                        return {
                            knowledge: kMax > 0 ? (kTotal / kMax) * 100 : 0,
                            skills: sMax > 0 ? (sTotal / sMax) * 100 : 0,
                            wisdom: wMax > 0 ? (wTotal / wMax) * 100 : 0
                        };
                    },

                    calculateRating(hunter, wisdomOverride = null) {
                        const stats = this.getCategoryStats(hunter);
                        const wScore = wisdomOverride !== null ? wisdomOverride : stats.wisdom;
                        return (stats.knowledge * this.K_WEIGHT) + (stats.skills * this.S_WEIGHT) + (wScore * this.W_WEIGHT);
                    },

                    updateSimulation(value, hunterId) {
                        const wisdomVal = document.getElementById('ht-wisdom-val');
                        const simRating = document.getElementById('ht-sim-rating');
                        if (wisdomVal) wisdomVal.textContent = `${value}%`;

                        const hunter = this.findHunter(hunterId);
                        if (!hunter || !simRating) return;

                        const projected = this.calculateRating(hunter, Number(value));
                        simRating.textContent = `Sim: ${projected.toFixed(1)}%`;

                        simRating.className = "text-[10px] font-bold ml-1 transition-colors duration-300 " +
                            (projected >= 90 ? 'text-yellow-400' : projected >= 75 ? 'text-blue-400' : 'text-red-500');
                    },

                    renderCharts(hunter) {
                        const stats = this.getCategoryStats(hunter);

                        // --- 1. History Trajectory Chart (Chronological) ---
                        const trajCtx = document.getElementById('ht-trajectory-chart');
                        if (trajCtx && typeof Chart !== 'undefined') {
                            const historyLabels = ['Start'];
                            const historyK = [0];
                            const historyS = [0];

                            const sortedQuests = (hunter.CompletedQuests || []).slice().sort((a, b) => {
                                const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                                const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                                return dateA - dateB;
                            });

                            let kRunTotal = 0, kRunMax = 0;
                            let sRunTotal = 0, sRunMax = 0;
                            const allQuests = App.state.systemData?.quests || [];

                            sortedQuests.forEach((cq, index) => {
                                const quest = allQuests.find(q => q.ID === cq.quest_id);
                                if (!quest) return;

                                const cat = quest.Category || 'SKILLS';
                                const score = Number(cq.xp_awarded || cq.total_xp || 0);
                                const max = Number(quest.TotalXP || 0);

                                if (cat === 'KNOWLEDGE') { kRunTotal += score; kRunMax += max; }
                                else if (cat !== 'SIDE' && cat !== 'WISDOM') { sRunTotal += score; sRunMax += max; } // Skills

                                // Add point
                                const label = cq.timestamp ? new Date(cq.timestamp).toLocaleDateString([], { month: 'numeric', day: 'numeric' }) : `Q${index + 1}`;
                                historyLabels.push(label);
                                historyK.push(kRunMax > 0 ? (kRunTotal / kRunMax) * 100 : 0);
                                historyS.push(sRunMax > 0 ? (sRunTotal / sRunMax) * 100 : 0);
                            });

                            new Chart(trajCtx, {
                                type: 'line',
                                data: {
                                    labels: historyLabels,
                                    datasets: [
                                        { label: 'Knowledge', data: historyK, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.2)', fill: true, pointRadius: 2 },
                                        { label: 'Skills', data: historyS, borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.2)', fill: true, pointRadius: 2 }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { labels: { color: '#9ca3af', font: { size: 9 } } } },
                                    scales: {
                                        x: { ticks: { color: '#6b7280', maxRotation: 45, minRotation: 45, font: { size: 8 } }, grid: { color: '#374151' } },
                                        y: { min: 0, max: 100, ticks: { color: '#6b7280', font: { size: 8 } }, grid: { color: '#374151' } }
                                    }
                                }
                            });
                        }

                        // --- 2. Radar Chart ---
                        const radarCtx = document.getElementById('ht-radar-chart');
                        if (radarCtx && typeof Chart !== 'undefined') {
                            new Chart(radarCtx, {
                                type: 'radar',
                                data: {
                                    labels: ['', '', ''],
                                    datasets: [{
                                        label: 'Build',
                                        data: [stats.knowledge, stats.skills, stats.wisdom],
                                        backgroundColor: 'rgba(59, 130, 246, 0.3)',
                                        borderColor: '#3b82f6',
                                        pointBackgroundColor: '#3b82f6'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: {
                                        r: {
                                            min: 0, max: 100,
                                            ticks: { color: '#6b7280', backdropColor: 'transparent', font: { size: 8 }, count: 5 },
                                            grid: { color: '#374151' },
                                            angleLines: { color: '#374151' },
                                            pointLabels: { color: '#9ca3af', font: { size: 10 } }
                                        }
                                    }
                                }
                            });
                        }
                    },

                    resizeImage(file, maxWidth = 600) {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    if (width > maxWidth) {
                                        height = height * (maxWidth / width);
                                        width = maxWidth;
                                    }
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    resolve(canvas.toDataURL(file.type));
                                };
                                img.onerror = reject;
                                img.src = event.target.result;
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                    },

                    getDirectGdriveUrl(url) {
                        if (!url || typeof url !== 'string') return null;
                        // If already a thumbnail URL, return as-is (best for embedding)
                        if (url.includes('drive.google.com/thumbnail')) {
                            return url;
                        }
                        const match = url.match(/id=([a-zA-Z0-9_-]+)|drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)|drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
                        const id = match ? (match[1] || match[2] || match[3]) : null;
                        // Use thumbnail format for better embedding
                        return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w1000` : url;
                    },
                    async fetchImageWithRetries(url, attempts = 3) {
                        if (!url) throw new Error("No URL provided");
                        for (let i = 0; i < attempts; i++) {
                            try {
                                const fetchUrl = i === 0 ? url : `${PROXIES[(i - 1) % PROXIES.length]}${encodeURIComponent(url)}`;
                                const response = await fetch(fetchUrl);
                                if (!response.ok) throw new Error(`Response not OK: ${response.status}`);
                                const blob = await response.blob();
                                if (!blob.type.startsWith('image/')) throw new Error('Returned data is not an image.');
                                return blob;
                            } catch (error) {
                                if (i < attempts - 1) await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        throw new Error(`All ${attempts} attempts to fetch the image failed.`);
                    },
                    async processImages(selector) {
                        const images = document.querySelectorAll(selector);
                        // SEQUENTIAL LOADING: Prevents network flooding/hanging
                        for (const img of images) {
                            const rawUrl = img.dataset.src;
                            if (!rawUrl || rawUrl === 'undefined' || rawUrl === 'null') continue;

                            // Cache Check
                            if (window.HTImageCache && window.HTImageCache.has(rawUrl)) {
                                img.src = window.HTImageCache.get(rawUrl);
                                continue;
                            }

                            if (rawUrl.startsWith('data:')) { img.src = rawUrl; continue; }

                            try {
                                const blob = await this.fetchImageWithRetries(this.getDirectGdriveUrl(rawUrl));
                                const objUrl = URL.createObjectURL(blob);

                                // Set Cache
                                if (window.HTImageCache) window.HTImageCache.set(rawUrl, objUrl);

                                img.src = objUrl;
                            } catch (e) {
                                img.style.opacity = 0.5;
                            }
                        }
                    }
                }
            };

            // Expose App globally for inline onclicks in generated HTML
            window.App = App;

            // Start System
            App.init();
        });
    </script>
</body>

</html>
